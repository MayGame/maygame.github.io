<script src="js/cdn/ejs.min.js"></script>
<button style="background-color: #bb00bb; height: 20vh; width: 20vw; font-size: 1.7rem;" onclick="t2p();">Tap to
  play</button>
<br>
<p><a href="https://maygame.xxx/default">Load sample</a></p>
<br>
<button onclick="
fetch('').then((response)=>{response.text().then((e)=>console.log(e))});

">Test</button>

<br>
<!--  -->
<br>
<h1>Init</h1>
<br>
<!-- Content security policy stuff: todo -->
<label for="config_url">url to fetch your config from</label>
<input type="text" value="config/sample.json" id="config_url">
<button onclick="
fetch_config(config_url.value)
">Load config file</button><br>
<!-- todo: validate -->
<button onclick=";(async ()=>{
let core = config.core.url;
fetch(core).then((response)=>{response.text().then((e)=>{
let result = ejs.render(e,config.replace)
cache_as(result,'core_something.html')//fixme, todo
});
});
})();
">Load from config</button><button
onclick="
ediv.innerHTML=ejs.render(config_div_template,config)
"
>Edit config</button>
<div id="ediv" style="position: absolute; right: 0; bottom: 0; background-color: pink;"></div>
<!-- fixme. proper awaits + chaining -->
<script>
var config_initial
var config_div_template=`
<p>Testing stuff: <input type="text" value="<%= core.url %>" disabled></p>
<select id="config_select" onchange="
edconf_key.value=this.value;
let t = config_select.options[config_select.selectedIndex].text;
edconf_value.value=t;
edconf_old_value.innerText=config_initial.replace[t];
">
    <% Object.keys(replace).forEach(function(key) { %>
       <option value="<%= replace[key] %>"><%= key %></option>
    <% }); %>
</select><input type="text" id="edconf_key"><input type="text" id="edconf_value"><p>old value: <a id="edconf_old_value"></a></p>
<button onclick="edconf_key.value=>console.log">Apply</button>
`

function cache_as(html,link){
  console.log('cache_as +2. Link, html')
  console.log(link)
  console.log(html)
}
var config
async function fetch_config(url){
  fetch(url).then((response)=>{response.json()
  .then(cfg=>{config = cfg; config_initial = cfg; console.log(cfg)})
})}
</script>
<br>
<h1>-------------------------------</h1>
<!--  -->
<br>
<button>Change default behavior</button>
<br>
<h1>Data server: <input type="text" placeholder="gun instance"></h1>
<br>
<h1>Default behavior:</h1>
<label for="rb_load_last">Load last used</label>
<input type="radio" checked name="def_beh" value="rb_load_last" id="rb_load_last"><br>

<label for="rb_load_newest">Load newest</label>
<input type="radio" name="def_beh" value="rb_load_newest" id="rb_load_newest"><br>

<label for="rb_load_template">Load from template</label>
<input type="radio" name="def_beh" value="rb_load_template" id="rb_load_template"><br>

<label>Customize</label>
<input type="checkbox" id="cb_customize" value=""><br>


<button id="btn_customize_submit" onclick="customize_submit();">Submit</button>

<!-- #region -->
<h1>Customization:</h1>
<div id="customization_div" style="background: mediumorchid;">

  <p>Load modules:</p>
  <ul>
    <li><label for="module_core_head">Core head</label><input type="checkbox" id="module_core_head" checked disabled>
    </li>
    <li><label for="module_%name%">Name</label><input type="checkbox" id="module_%name%" checked></li>
    <li><label for="module_core_body">Core body</label><input type="checkbox" id="module_core_body" checked disabled>
    </li>
    <li><label for="module_core_footer">Core footer</label><input type="checkbox" id="module_core_footer" checked
        disabled></li>
    <!-- groups: unchecking one unchecks related (todo) -->
  </ul>

  <label>Save template as</label>
  <input type="text" id='text_save_as' disabled>
  <input type="checkbox" id="cb_save_as" value="" onchange="
text_save_as.disabled=!text_save_as.disabled;
btn_to_gun.disabled=!btn_to_gun.disabled;
btn_to_local.disabled=!btn_to_local.disabled
 ">
  <button id='btn_to_gun' disabled>To gun</button>
  <button disabled id="btn_to_local">To localStorage</button>
  <br>
</div>
<!-- #endregion -->
<script id="js_sw" type="text/javascript">
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('scsw.js').then(function (registration) {
        // Registration was successful
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, function (err) {
        // registration failed :(
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
<script id="js_init">
  ; (() => {
    // localStorage.setItem('start_init_default','rb_load_newest')
    let def = localStorage.getItem('start_init_default');

  })();
</script>
<script id="dev_js">
  var modules = {
    'head': {
      'text': `
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>MayGame</title>
  <meta name="description" content="No description">
  <meta name="author" content="Some dude">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script id="gun_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/gun.js"><`+ `/script>
  <script id="sea_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/sea.js"><`+ `/script>
  <script id="wsjs_innerscript" src="js/core/wsjs.js"><`+ `/script>
  <link id="css_styles_core" rel="stylesheet" href="css/styles.css" />
</head>
  `},
    'body': {
      'text': `
<body style="background-color: pink;">
            
            `},
    'footer': {
      'text': `
</body>
</html>`}
  }
  var a = { 'name': 'core', 'version': 1, 'deps': [] }
  var minmod = { 'name': 'module_name', 'text': '', 'dom_place': 'head' }
  var minmod2 = { 'name': 'module_name', 'url': 'modules/module_name/3.json' }
    //fixme: load order, versioning, different sources (todo!)
    // alert(def)
  /**
   * two versions (parts?) of modules: dom object, plain text.
   * first is used for dom modification, second is appended and cached
  */
</script>
<script>
  function customize_submit() {
    const rbs = document.querySelectorAll('input[name="def_beh"]');
    let selectedValue;
    let cdiv = customization_div
    for (const rb of rbs) {
      if (rb.checked) {
        selectedValue = rb.value;
        break;
      }
    }
    let checked = cb_customize.checked
    if (checked) {
      if (selectedValue == 'rb_load_last')
        cdiv.innerHTML = 'customize last'
      else if (selectedValue == 'rb_load_newest')
        cdiv.innerHTML = 'newest '
    }
  };

  function t2p() {
    var mods = { 'name': 'a', }
    let result = ''
    let header_close = '</head>'
    let header = modules.head.text
    let body = modules.body.text
    let footer = modules.footer.text
    result += header + body + footer
    console.log(result)
    let url = 'core_sample.html'
    //#region second login 
    console.log(localStorage.getItem('cached_core'))
    //#endregion
    //cache result, url = cached core link, if no cached version already
    window.open(url, '_blank');


  }
  var lastCached
</script>