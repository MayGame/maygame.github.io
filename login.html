<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<!--  -->
<button onclick="hide_not_implemented()">Hide not implemented stuff</button>
<br>
<br>
<br>
<label>Paste your key here to log in</label>
<textarea id="pasted_key">{"pub":"8zkWXFT6Qe9RKQ8l93IflY_w2CRz5oX2o1j6FCL36BY.WTdOwlnHfIkKxYV6LlOTtrBE4uD-9PPSQlNxcK9Cit8","priv":"S1iBnLH4Y0vnl72EWcV1wb91p5Ufy0FsDQ7o9ageNkc","epub":"Hmtozeo-xeNjaTcl9CPYf1kFH90Hg5KQt9L_oKKvL1U.gPYL1WQNI5_0UZ-fCyhT_EN-lFpzezC7fB8LjRGQD6g","epriv":"HbIViA2JjfJauUL_ziDrFNar3LVZxJgJHkvh751kkiM"}</textarea><br>
<button onclick="key_pasted()">Submit</button><br>
<br>
<br>
<br>
<label>Your key</label>
<textarea id="current_key" placeholder="not logged in"></textarea><br>
<button onclick="log_key()" style="background-color: beige;">Log my key</button><button style="background-color: aquamarine;" onclick="auth_()">Auth with this key</button><br>
<button onclick="console.log(gun._.graph)" style="background-color: beige;">log graph</button>
<br>
<button onclick="downloadPair()" style="background-color: red;">download pair</button>
<br>
<br>
<p>Or create a new one <button onclick="create_key()">Create key</button></p>
<div class="not_implemented">
<p>Enter your login/password to decrypt your key saved elsewhere.</p>
<label>Where</label>
<input type="text" id="server" value="https://vine-mature-morocco.glitch.me/gun" placeholder="your_node.address/gun"><br>
<label>Login</label>
<input type="text" id="login" value="YetAnotherGuy"><br>
<label>Password</label>
<input type="password" id="password" value="MJ4e"><br>
<button onclick="alert('Not implemented yet')">login</button>
</div>
<br>
<br>
<br>
<br>
<input list="dl_pages" id="page_version" placeholder="page version to load">
<datalist id="dl_pages">
    <option value="1"></option>
</datalist>
<button onclick="load_page()">Load page version </button><a id="page_href">last one loaded</a>
<!--  -->
<br>
<label>Html snippet</label>
<textarea id="html_snippet"></textarea>
<br>
<label>name</label>
<input id="snippet_name" value="1" type="text">
<br>
<button onclick="save_snippet()">Save snippet</button>
<br>
<button onclick="replace()">replace</button>
<button onclick="replace_all()">replace all</button>
<!--  -->
<script id="test_js"></script>
<script>
var sea = Gun.SEA
var temp_key = null
var gun=null
var user = null//gun.user().recall({sessionStorage: true});
const account = {
  is: null,
  profile: {
    name: '',
  },
}

function hide_not_implemented(){
    var all = document.getElementsByClassName("not_implemented")
    Array.prototype.forEach.call(all, function(el){
    el.style.display="none";
    })}
function key_pasted(){
    var val = document.getElementById("pasted_key").value
    temp_key = val
    document.getElementById("current_key").value=temp_key;
    temp_key=JSON.parse(val)
}
async function create_key() {
temp_key =  await sea.pair();
document.getElementById("current_key").value=JSON.stringify(temp_key);
}
function log_key(){
    console.log(temp_key)
}
function init(){
    gun = new Gun()
user = gun.user()
user.recall({ sessionStorage: true }, () => {
  logIn()
})
gun.on('auth', () => {
  logIn()
})
}
async function load_page(){
    var val = document.getElementById("page_version").value
    var ref = val+".html"
    document.getElementById("page_href").setAttribute("href", ref)
    user.get("pages").get("html").get(value)
}
init()
function logIn(){  
    account.is = gun.user().is
    console.info('Logged in as ', account.is.pub)
    loadProfile(account.is.pub)
}
function auth_(){
user.auth(temp_key)
console.log(user.is)
console.log(user._.sea)
}
function loadProfile(pub) {
  gun
    .user()
    .get('profile')
    .map()
    .on((data, key) => {
      account.profile[key] = data
    })
}
function updateProfile(field, data) {if (data !== undefined)gun.user().get('profile').get(field).put(data)}
function downloadText(text, fileType, fileName) {
  var blob = new Blob([text], { type: fileType })

  var a = document.createElement('a')
  a.download = fileName
  a.href = URL.createObjectURL(blob)
  a.dataset.downloadurl = [fileType, a.download, a.href].join(':')
  a.style.display = 'none'
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  setTimeout(function () {
    URL.revokeObjectURL(a.href)
  }, 1500)
}
function downloadPair() {
  let pair = gun.user()._.sea
  pair = JSON.stringify(pair)

  downloadText(
    pair,
    'application/json',
    // account.profile.name + '@key.json',
    '@key.json',
  )
}
</script>