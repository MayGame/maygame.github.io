<html>
    <head>

<script id="gun_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script id="sea_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js" integrity="sha512-ZuOjyqq409+q6uc49UiBF3fTeyRyP8Qs0Jf/7FxH5LfhqBMzrR5cwbpDA4BgzSo884w6q/+oNdIeHenOqhISGw==" crossorigin="anonymous"></script>
<script id="wsjs_innerscript" src="../../js/core/wsjs.js"></script>
<link id="css_styles_core" rel="stylesheet" href="../../css/styles.css" />

    </head>
    <body>
        <!-- <div class="layer" style="display: none; z-index: 200;background-color: deeppink;" id="tasks_layer"> -->
            <div class="layer" style="display: grid; z-index: 200;background-color: deeppink; visibility: hidden;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            grid-template-areas: 'top top top' 'midleft mid midright' 'bot bot bot';
            " id="tasks_layer">
           <div style="height: 100%; grid-area: mid;">
               <button style="height: 100%;width: 100%;">button</button>    
            </div>
            </div>
        <div style="display: grid; grid-template-columns: 50vw 50vw;">
            <div>
                <!-- <button onclick="toggle(tasks_layer);setTimeout(()=>toggle(tasks_layer),4000)">tasks</button> -->
                <button onclick="vtoggle(tasks_layer);setTimeout(()=>vtoggle(tasks_layer),4000)">tasks</button>
                <button onclick="console.table(vars);">Show vars</button><br>
                <textarea id="var_name_area"></textarea><button onclick="add_var(var_name_area.value);" >Add</button>
            <p>---------------------------------</p>
        </div>
        <div>   <p>todo: tags, agents</p>
                <button onclick="console.clear(); console.table(tasks_priorities);">Show tasks</button><br>
                <textarea id="task_name_area"></textarea><button onclick="create_task(task_name_area.value);" >Create</button>
<p>Task: context needed, sub tasks, performer.</p>
<p>context map</p>
<p>For task in tasks where importance is above threshold</p>
<p></p>
<label>#task</label><input type="number" onchange="
console.clear();console.table(tasks_priorities);
let a=tasks_priorities[this.value];
console.log(a);
if(!a)console.log('!a')
else{
if(tasks[a[0]])
console.log(tasks[a[0]]);
else console.log('no such task, add?');}
"><br>
<div id="add_task_div" style="display: none;">
<button>Add</button>
</div>
<button onclick="manage_subs(0);">manage subs</button>
<button onclick="sub_on('pulse');">Sub pulse</button>
<button onclick="sub_off('pulse');">Unsub pulse</button>
<button onclick="process_frame();">Tick</button>
<p>---------------------------------</p>
            </div>
        </div>
        <script>
var gun = Gun();
var subbed={};
var gun_vars=gun.get('vars');
var state={}
//#region utils
function gun_filter(obj){//todo (attention marker!) might need those nulls sometimes. 
    //swapping whole objects is a chosen strategy for now
    if(_.isObject(obj)){
    let result = {}
    _.keys(obj).forEach(key=>{
        // if(obj[key])//a:0 would be ignored too
            if(key != '_')
                result[key]=obj[key];
    })
    return result;
} else return obj;}
function sub_(gun_obj,callback){
                ev = 2;//placeholder. if it's 2, then node we are subscribing to never existed. .off whole event
                gun_obj.on((data,key,msg,eve)=>{
                    ev=eve;
                    // console.log(eve);
                    callback(data,key);
                })
                return ev;
            }
function sub_on(name){
    //fixme, map resolve for complex objects (a is b thing)
    function cb(data,key){
        // if(!isValid(data)){ return }//validity check, maybe schema, when needed
        // console.log(name,data,key)
        frame[key]=gun_filter(data);
    }
    if(!subbed[name])
subbed[name]=sub_(gun_vars.get(name),cb);
else console.log('already subscrbed',subbed)
}
function sub_off(name){
    if(!subbed[name])
    console.log('not subbed', name);
    else {
        if(subbed[name!=2])
        subbed[name].off();        else 
        gun_vars.get(name).off();//removes all, but we don't use multiple anyways. prob fixme
    delete subbed[name];}
}
function manage_subs(threshold){
                vars.forEach(e=>{
                    if(e[1]>=threshold){
                        sub_on(e[0])
                    }
                    else sub_off(e[0]);
                })
                console.log('subbed',subbed)
            }
            var vars=[['pulse',3],['lights',0],['sugar',2],['task_submit',0],['test',2],['brain_works',5]];//name, importance
            var something_else='?';//fixme. special marker, that we should add here
            var tasks_priorities=[['stay healthy',0.9],['be happy', 0],['become',0]]//be happy isn't here, task add 
            var tasks={'stay healthy':{context:{vars:['pulse','sugar']
            //vars - top level context. not counting needed for subs. usually reports from subs go there
            ,tasks:['pulse_is_ok',something_else],}},
    }//context - names
    var ui_frame=[];
    var reactions={test_alert:function(){alert('test')}};
    var frame={};//changed vars. update sets those. ones above threshold are subscribed to
    var reverse_index={'test':'test_alert'}//name to callbacks (react) react as in reaction
function resolve(name){
    // sees what to recalculate for updated state
    // Object.keys(tasks_priorities)
    // for(i=0;i<tasks_priorities.length;i++)
    // tasks_priorities
}
function process_frame(){
    console.log('process frame', frame)
    const t0 = performance.now();
    Object.keys(frame).forEach(key=>{
state[key]=frame[key];
resolve(key)
    })
    frame={}
    const took = performance.now()-t0;
    console.log('took, ms:',took)
    return took;
}
function force_frame(threshold){
//manually loads (once) vars we ignored.. maybe second threshold for delayed?
//like remember but do nothing fo now
}
            var recalc_importance_threshold=2;
            function compare_priorities(a,b){
                return b[1]-a[1];
            }
            //urgent task - raise the priority, maybe change threshold.
            //idling - lower threshold (lower - verb)
            vars=vars.sort(compare_priorities);
            function show_important(){
            }
            console.table(vars)
            console.table(tasks_priorities)
        </script>
        <script>
            function add_var(name,priority){
                if(priority)
                vars.push([name, priority]);
                //arr.splice(getindex(priority), 0, [name, priority]);
                else
                vars.push([name, 0]);
            }
            function create_task(name,priority){
                // if(priority)
                // tasks.push([name, priority]);
                // //arr.splice(getindex(priority), 0, [name, priority]);
                // else
                tasks[name]={};
            }
        </script>
    </body>
</html>