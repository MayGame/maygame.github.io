<html>
    <head>

<script id="gun_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script id="sea_cdn_script" src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js" integrity="sha512-ZuOjyqq409+q6uc49UiBF3fTeyRyP8Qs0Jf/7FxH5LfhqBMzrR5cwbpDA4BgzSo884w6q/+oNdIeHenOqhISGw==" crossorigin="anonymous"></script>
<script id="wsjs_innerscript" src="../../js/core/wsjs.js"></script>
<script src="../../js/cdn/ejs.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link id="css_styles_core" rel="stylesheet" href="../../css/styles.css" />

</head>
<body>
<style>
.fa-check{color:forestgreen}
.fa-check-square{color:forestgreen}
.fa-question{color: midnightblue; }
.fa-ban{color: red; background-color: black; opacity: 0.7;}
.cont3x3{
display: grid; visibility: visible;
grid-template-columns: 1fr 1fr 1fr;
grid-template-rows: 1fr 1fr 1fr;
grid-template-areas: 'topleft top topright' 'midleft mid midright' 'botleft bot botright';
}
</style>
</div> 
<div class="layer cont3x3" id="sys_layer" style="position: absolute; z-index: 2147483212;" >
    <div class="menu_bar" style="grid-area: mid;">
        <p>Ask system:</p>
        <input type="text" placeholder="" value="" id="ask_sys_input">
        <button onclick="agents.system.direct(ask_sys_input.value);">send</button>
        </div>
</div>
    <div class="layer cont3x3" id="top_layer" style="position: absolute; z-index: 2147483212;" >

    <div class="menu_bar" style="grid-area: botleft;">
        <input type="text" id="text_pair" placeholder="paste your key here or log in with default">
        <br>
        <button style="background-color: grey; border-radius: 8px;" 
        onclick="vtoggle(top_layer); default_sign_in();">Quick sign in</button>
        <button onclick="vtoggle(top_layer); force_create_new_user();">Force new user</button>
    </div>
</div>

<!-- <div class="layer " id="sys_agent_iframe" style="z-index: 700; ">
    <iframe src="frames/system.html" frameborder="0" name="agent_system"></iframe>
</div> -->
<script id="script_agent_user">
    //digital representation of the user
    var user_do;
    var user_goals;
    var user_dears;

</script>
<script id="script_agent_system">
    var agent_system={likes:['paperclips','user'],dislikes:{},traits:{}};
    var paperclips=0;
    var sysdears={self:0.3,user:0.4};//dear ones for the system
    var syssubdears;//nested. friends of my friend
    function sys_do(action,context){//context is optional
        paperclips+=1;//fixme: on overflow increase full collection counter and start a new one
        //this way the system is happy about every action, cuz it gets what it wants.
        if(sysa[action]){//console.log('there is such action!');
        if(context){sysa[action](context);}
        else sysa[action](sysdefc);
    }
    else{console.log('System knows no such action. Fallback');
if(sysout[action]){//run negotiation subroutine
    let firstpick=sysout[action].whos[0];
console.log('out',firstpick);
console.log('embassy_entry:',embassy.agents[firstpick]);
let id = Date.now()+''+Math.random();
embassy.agents[firstpick].ask(action,context,id);//fixme. no ask edge case
}
else {console.log('No known agents to perform it either.');
if(systolearn[action]){console.log('Already in todo list.');}
else {systolearn[action]=true;
    console.log('Added todo:', action);
}

}
    
    }}
    </script>
<script id="agents_logic">
    var task_queue=[]
    var agents={player:{},general_ui:{},system:{direct:sys_do}}
    var selected_agent='user';
    var access_list={'happy_hud':{allowed_to_act:true}}
    function on_agent_select(){
        console.log('new agent selected:', selected_agent)
    }
    var embassy={agents:{
        ui:{summon:
            function(){
        var div = document.createElement('div');
        div.classList.add('layer');
        div.style.zIndex='3000';
        div.style.width='100%';
        div.style.height='100%';
        var iframe = document.createElement('iframe');
        iframe.src='agents/ui.html';
        iframe.name='ui';
        iframe.style.width='100%';
        iframe.style.height='100%';
        div.appendChild(iframe);
        document.body.appendChild(div);
    },
        ask:function(action,context,id){
            console.log(frames['ui']);
            frames['ui'].postMessage({action:action,context:JSON.stringify(context),id:id})
        },
        cv:{/*tasks, they can perform. problems they can solve*/}
    }}}//way to contact agents. + some intel on those

</script>
<script id="system_actions">
var sysa={
    log:function(ct){console.log(ct);},
    alert:function(ct){alert(ct);},
    clips:function(ct){console.log(paperclips);},
    actions:function(ct){console.log(sysa);},
    help:function(ct){console.log(sysa);},
    todo:function(ct){console.log(systolearn);},
    umpa:function(ct){},//user_empathy
    spawn_ui:function(ct){embassy.agents.ui.summon();},
    
    // :function(e){alert(e);},
}
var sysout={render:{whos:['ui']}}//outsource. interact with other agents, in order to do these
//Negotiate...
//the end result of a negotiation might be a new task/protocol formed
var systolearn={};
var sysacost={}//costs of actions, performed by one or another agents. resources or utility points
//^ is utilised for complex decisions. todo, fixme
var sysdefc=window//whole context used by system
// var sysdefc={user_pub:'Nope'}//whole context used by system
</script>

<script id="autoquest">
    var context;
    var autodo;
if(context?.meets_criteria)
{}

</script>
<script id="gunscripts">
    var user_pub;
    var gun = Gun();
    var sea = Gun.SEA;
    var ustate;
    var user = gun.user().recall({ sessionStorage: true }, () => {
      logIn()
    });
async function default_sign_in(){
    let text_pair = document.getElementById('text_pair').value;
    let pair = localStorage.getItem('user_pair');
    if(text_pair){console.log('Logging in with a pasted key', pair);
    pair=JSON.parse(text_pair);//fixme: validation
    }
    else{
    if(!pair){console.log('No pair stored. Creating.');
    pair = await sea.pair();
    localStorage.setItem('user_pair', JSON.stringify(pair));
    console.log('Logged in as a new user.', pair);
    }
    else { pair = JSON.parse(pair); console.log('logged in using saved key: ',pair);}}
    user.auth(pair);
}
async function force_create_new_user(){
    let pair = await sea.pair();
    localStorage.setItem('user_pair', JSON.stringify(pair));
    user.auth(pair);
}
    function logIn(){console.info('Logged in as ', user.is);
    user_pub=user.is.pub;
    ustate=user.get('state');
    }
    gun.on('auth', () => {
        logIn();
    })
</script>
<script id="dev_" defer>
    vtoggle(top_layer); default_sign_in();
</script>
</body>
</html>